# These steps have to run on a windows machine,
# and therefore unfortunately can't be integrated in the regular steps

steps:
  - task: UseDotNet@2
    condition: succeededOrFailed()
    displayName: "Use .NET Core sdk 3.x"
    inputs:
      version: 3.x
      steps:

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-credscan.CredScan@3
    condition: succeededOrFailed()
    displayName: "ðŸ§­ Run Credential Scanner"
    inputs:
      debugMode: false

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-eslint.ESLint@1
    condition: succeededOrFailed()
    displayName: "ðŸ§­ Run ESLint"

- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
  displayName: ESRP CodeSigning 400
  inputs:
    ConnectedServiceName: Teams ESRP CodeSign v3
    FolderPath: $(System.DefaultWorkingDirectory)
    Pattern: "impossible.pattern.that.we.dont.have"
    signConfigType: inlineSignParams
    inlineOperation: |
      [
        {
          "KeyCode" : "CP-230012",
          "OperationCode" : "SigntoolSign",
          "Parameters" : {
            "OpusName" : "Microsoft",
            "OpusInfo" : "http://www.microsoft.com",
            "FileDigest" : "/fd \"SHA256\"",
            "PageHash" : "/NPH",
            "TimeStamp" : "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
          },
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        },
        {
          "KeyCode" : "CP-230012",
          "OperationCode" : "SigntoolVerify",
          "Parameters" : {},
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        }
      ]
    SessionTimeout: 60
    VerboseLogin: false

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-publishsecurityanalysislogs.PublishSecurityAnalysisLogs@3
    displayName: "ðŸ§­ Publish Guardian Artifacts - All Tools"
    inputs:
      ArtifactType: M365
    condition: succeededOrFailed()

  - task: AssetRetention@3
    displayName: ðŸ§­ Arrow Retention
    inputs:
      ArrowServiceConnection: "Arrow_Domoreexpgithub_PROD"
      AssetGroupName: "$(System.TeamProject)_$(Build.DefinitionName)"
      AssetNumber: "$(Build.BuildId)"
      IsShipped: false
      DropsToRetain: "CodeAnalysisLogs"
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-postanalysis.PostAnalysis@2
    displayName: "ðŸ§­ Guardian Break"
    inputs:
      GdnBreakPolicyMinSev: Warning
      GdnBreakAllTools: true
      GdnBreakGdnToolESLint: true
      GdnBreakGdnToolESLintSeverity: Warning
      GdnBreakPolicy: M365
    condition: succeededOrFailed()
